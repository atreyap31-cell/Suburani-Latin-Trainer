<!DOCTYPE html>
<html lang="en">
<head>
        <link rel="icon" type="image/png" href="favicon.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suburani Cloud: Ultimate</title>
    <!-- OCR Engine (Stable v4) -->
    <script src='https://unpkg.com/tesseract.js@4.0.2/dist/tesseract.min.js'></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        :root {
            --bg-deep: #050505;
            --glass-panel: rgba(20, 20, 20, 0.90);
            --glass-border: rgba(255, 255, 255, 0.1);
            --primary: #64b5f6;
            --accent: #4dd0e1;
            --success: #66bb6a;
            --danger: #ef5350;
            --warning: #ffa726;
            --text-main: #e0e0e0;
            --text-muted: #9e9e9e;
            --font-main: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            --font-serif: 'Georgia', serif;
        }

        * { box-sizing: border-box; }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-deep);
            color: var(--text-main);
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='400' viewBox='0 0 800 800'%3E%3Cg fill='none' stroke='%23303030' stroke-width='1.5'%3E%3Cpath d='M769 229L1037 260.9M927 880L731 737 520 660 309 538 40 599 295 764 126.5 879.5 40 599-197 493 102 382-31 229 126.5 79.5-69-63'/%3E%3Cpath d='M-169 786L-169 517 79 310.2 362 393.8 531 349 792 72 853 329 896 618 692 849 531 668 220 755 87 649'/%3E%3Cpath d='M789 749L601 547 433 469 193 547 51 469-87 319-38 107 222 28 433 133 601 28 789 203 943 133 943 361 789 547'/%3E%3Cpath d='M585 918L433 755 193 849 51 755-144 602-230 382-144 203 12 107 193-27 433-27 601 107 789 28 943 203 943 602 789 755'/%3E%3C/g%3E%3C/svg%3E");
            background-size: 600px 600px;
            animation: drift 60s linear infinite;
        }
        @keyframes drift { from { background-position: 0 0; } to { background-position: 100% 100%; } }

        .hidden { display: none !important; }
        .app-container { display: flex; height: 100vh; width: 100%; }
        main { flex: 1; padding: 40px; overflow-y: auto; position: relative; }
        main.no-padding { padding: 0; overflow: hidden; }
        .container { max-width: 900px; margin: 0 auto; animation: fadeUp 0.4s ease; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* HOME */
        #app-home { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10; position: relative; }
        .home-title { font-size: 3rem; font-weight: 800; background: linear-gradient(135deg, var(--primary), var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 40px; text-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .card-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 30px; max-width: 1000px; width: 100%; padding: 20px; }
        .menu-card { background: var(--glass-panel); backdrop-filter: blur(10px); border: 1px solid var(--glass-border); border-radius: 20px; padding: 40px 20px; text-align: center; cursor: pointer; transition: all 0.3s; position: relative; overflow: hidden; }
        .menu-card:hover { transform: translateY(-10px); border-color: var(--primary); box-shadow: 0 15px 40px rgba(100, 181, 246, 0.2); }
        .menu-card i { font-size: 3rem; color: var(--text-muted); margin-bottom: 20px; transition: 0.3s; }
        .menu-card:hover i { color: var(--primary); transform: scale(1.1); }
        .menu-card h3 { font-size: 1.5rem; margin: 0; color: var(--text-main); }
        .menu-card p { color: var(--text-muted); font-size: 0.9rem; margin-top: 10px; }
        .watermark { position: absolute; bottom: 20px; right: 25px; font-family: var(--font-serif); color: var(--text-muted); opacity: 0.3; font-size: 0.9rem; letter-spacing: 1px; pointer-events: none; }

        /* SIDEBAR */
        aside { width: 260px; background: var(--glass-panel); backdrop-filter: blur(15px); border-right: 1px solid var(--glass-border); display: flex; flex-direction: column; padding: 25px; z-index: 20; }
        .brand { font-size: 1.4rem; font-weight: 700; color: var(--primary); margin-bottom: 40px; display: flex; align-items: center; gap: 12px; cursor: pointer; }
        nav button { background: transparent; color: var(--text-muted); border: none; width: 100%; text-align: left; padding: 15px; margin-bottom: 10px; border-radius: 12px; cursor: pointer; font-size: 1rem; display: flex; align-items: center; gap: 15px; transition: all 0.3s; }
        nav button:hover { background: rgba(255, 255, 255, 0.05); color: var(--text-main); transform: translateX(5px); }
        nav button.active { background: linear-gradient(90deg, rgba(100,181,246,0.2) 0%, transparent 100%); color: var(--primary); border-left: 3px solid var(--primary); }

        /* COMPONENTS */
        h2 { border-bottom: 1px solid var(--glass-border); padding-bottom: 15px; margin-top: 0; font-weight: 300; letter-spacing: 1px; }
        .card { background: var(--glass-panel); backdrop-filter: blur(10px); border: 1px solid var(--glass-border); border-radius: 16px; padding: 20px; margin-bottom: 25px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); }
        textarea { width: 100%; height: 250px; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); border-radius: 8px; color: var(--text-main); padding: 20px; font-family: var(--font-serif); font-size: 1.2rem; resize: vertical; outline: none; }
        textarea:focus { border-color: var(--primary); }
        .btn { padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; border: none; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: #000; }
        .btn-ghost { background: transparent; color: var(--accent); border: 1px solid var(--glass-border); }
        .btn-magic { background: linear-gradient(45deg, #7b1fa2, #4a148c); color:white; box-shadow: 0 0 10px rgba(123,31,162,0.5); }

        /* FLASHCARDS */
        .embed-frame { width: 100%; height: 100%; border: none; display: block; background: #fff; }
        .tiny-home-btn { position: absolute; top: 20px; left: 20px; z-index: 1000; background: rgba(20, 20, 20, 0.85); backdrop-filter: blur(8px); color: var(--text-main); border: 1px solid var(--glass-border); padding: 10px 18px; border-radius: 30px; cursor: pointer; }

        /* PARADIGM & TEST */
        .paradigm-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 1rem; }
        .paradigm-table th { text-align: left; padding: 12px; border-bottom: 2px solid var(--primary); color: var(--primary); }
        .paradigm-table td { padding: 12px; border-bottom: 1px solid var(--glass-border); }
        .noun-test-grid { display: grid; grid-template-columns: 100px 1fr 1fr; gap: 15px; margin-top: 20px; align-items: center; }
        .verb-test-container { display: grid; grid-template-columns: 100px 1fr; gap: 15px; margin-top: 20px; max-width: 600px; margin: 0 auto; align-items: center; }
        .noun-header { font-weight: bold; color: var(--primary); text-align: center; }
        .noun-label, .verb-person { font-weight: bold; color: var(--text-muted); text-align: right; padding-right: 15px; }
        .input-group { display: flex; gap: 5px; align-items: center; width: 100%; }
        input.test-input { width: 100%; flex: 1; background: rgba(0,0,0,0.4); border: 1px solid var(--glass-border); color: #fff; padding: 12px; border-radius: 8px; font-size: 1.2rem; font-family: var(--font-serif); text-align: center; }
        .btn-hint { background: rgba(255, 167, 38, 0.2); color: var(--warning); border: 1px solid var(--warning); border-radius: 8px; width: 40px; height: 45px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; }
        .correct { border-color: var(--success) !important; background: rgba(102, 187, 106, 0.15) !important; color: var(--success); }
        .incorrect { border-color: var(--danger) !important; background: rgba(239, 83, 80, 0.15) !important; color: var(--danger) !important; font-weight: bold; }
        .hinted-input { border-color: var(--warning) !important; background: rgba(255, 167, 38, 0.1) !important; color: var(--warning); }
        .macron-bar { display: flex; gap: 10px; margin-bottom: 25px; justify-content: center; background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; position: sticky; top:0; z-index:50; }
        .macron-btn { background: var(--bg-deep); color: var(--accent); border: 1px solid var(--accent); width: 45px; height: 45px; border-radius: 6px; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        /* READER & LINE */
        .latin-text { font-family: var(--font-serif); font-size: 1.6rem; line-height: 2; color: #ececec; }
        .word { cursor: pointer; border-bottom: 1px dashed rgba(255,255,255,0.2); border-radius: 4px; padding: 0 2px; }
        .word:hover { background-color: rgba(100, 181, 246, 0.2); color: #fff; border-bottom-color: var(--primary); }
        .line-item { margin-bottom: 25px; border-bottom: 1px solid var(--glass-border); padding-bottom: 25px; }
        .li-lat { font-family: var(--font-serif); font-size: 1.3rem; margin-bottom: 10px; color: #fff; }
        .li-trans { color: var(--success); font-size: 1.1rem; font-style: italic; margin-left: 15px; border-left: 3px solid var(--glass-border); padding-left: 10px; min-height: 1.5em; display: flex; align-items: center; }
        
        /* GLOSS CHIPS */
        .li-gloss { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .gloss-chip { background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); border-radius: 6px; padding: 5px 10px; font-size: 0.9rem; color: var(--text-muted); display: flex; align-items: center; gap: 6px; }
        .gloss-lat { color: var(--primary); font-weight: bold; }
        .def-match { color: var(--success); font-weight: bold; text-decoration: underline; text-decoration-color: var(--success); }

        /* OVERLAY */
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .scan-anim { width: 60px; height: 60px; border: 4px solid var(--primary); border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        .popover { position: fixed; bottom: 30px; right: 30px; width: 320px; background: rgba(20, 20, 20, 0.95); backdrop-filter: blur(15px); border: 1px solid var(--primary); border-radius: 12px; padding: 20px; display: none; z-index: 100; animation: slideIn 0.3s; }
        .loader { width: 14px; height: 14px; border: 2px solid #fff; border-radius: 50%; border-top-color: transparent; animation: spin 1s linear infinite; display:inline-block; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>

<div id="loading-overlay" class="hidden">
    <div class="scan-anim"></div>
    <h2 id="loading-text" style="color:white; font-weight:300;">Scanning...</h2>
    <p id="loading-sub" style="color:#aaa; font-size:0.9rem; margin-top:10px;"></p>
</div>

<!-- HOME -->
<div id="app-home">
    <div class="home-title">What are you studying?</div>
    <div class="card-grid">
        <div class="menu-card" onclick="router.open('flashcards')"><i class="fas fa-layer-group"></i><h3>Flashcards</h3><p style="color:var(--accent); font-weight:bold;">By Winston</p></div>
        <div class="menu-card" onclick="router.open('reading')"><i class="fas fa-book-open"></i><h3>Reading</h3><p>Reader, Translation & Quiz</p></div>
        <div class="menu-card" onclick="router.open('paradigm')"><i class="fas fa-table"></i><h3>Paradigm</h3><p>Grammar charts & Tests</p></div>
    </div>
    <div class="watermark">By Vīvax</div>
</div>

<!-- FLASHCARDS -->
<div id="app-flashcards" class="hidden" style="position:relative; width:100vw; height:100vh;">
    <div class="tiny-home-btn" onclick="router.home()"> <i class="fas fa-arrow-left"></i> Home </div>
    <main class="no-padding" style="width:100%; height:100%;">
        <iframe class="embed-frame" src="https://lazypanda5050.github.io/Latin-Flashcard-Trainer/"></iframe>
    </main>
</div>

<!-- PARADIGM APP -->
<div id="app-paradigm" class="hidden app-container">
    <aside>
        <div class="brand" onclick="router.home()"><i class="fas fa-arrow-left"></i> &nbsp;Home</div>
    </aside>
    <main>
        <div id="para-select" class="container">
            <h2>Grammar Paradigms</h2>
            <div style="text-align:center; margin-top:50px;">
                <div class="card-grid" style="max-width:800px; margin:0 auto; grid-template-columns: 1fr 1fr;">
                    <div class="menu-card" onclick="paradigmApp.show('nouns')"><i class="fas fa-cube"></i><h3>Study Nouns</h3></div>
                    <div class="menu-card" onclick="paradigmApp.show('verbs')"><i class="fas fa-running"></i><h3>Study Verbs</h3></div>
                    <div class="menu-card" onclick="paradigmApp.startTest('noun')"><i class="fas fa-pen-alt"></i><h3>Noun Test</h3><p>Cases (8 Questions)</p></div>
                    <div class="menu-card" onclick="paradigmApp.startTest('verb')"><i class="fas fa-pen-nib"></i><h3>Verb Test</h3><p>Conjugation (6 Questions)</p></div>
                </div>
            </div>
        </div>

        <div id="para-nouns" class="container hidden">
            <button class="btn btn-ghost" onclick="paradigmApp.reset()" style="margin-bottom:20px;">Back</button>
            <h2>Noun Declensions</h2>
            <div class="card">
                <h3>1st Declension</h3>
                <table class="paradigm-table"><tr><th>Case</th><th>Singular</th><th>Plural</th></tr><tr><td>Nominative</td><td>puella</td><td>puellae</td></tr><tr><td>Accusative</td><td>puellam</td><td>puellās</td></tr><tr><td>Dative</td><td>puellae</td><td>puellīs</td></tr><tr><td>Ablative</td><td>puellā</td><td>puellīs</td></tr></table>
            </div>
        </div>

        <div id="para-verbs" class="container hidden">
            <button class="btn btn-ghost" onclick="paradigmApp.reset()" style="margin-bottom:20px;">Back</button>
            <h2>Verb Tenses</h2>
            <div class="card">
                <h3>Present Tense</h3>
                <table class="paradigm-table"><tr><th>Person</th><th>Ending</th></tr><tr><td>Ego</td><td>-ō</td></tr><tr><td>Tu</td><td>-s</td></tr><tr><td>Is</td><td>-t</td></tr><tr><td>Nos</td><td>-mus</td></tr><tr><td>Vos</td><td>-tis</td></tr><tr><td>Ei</td><td>-nt</td></tr></table>
            </div>
        </div>

        <div id="para-test" class="container hidden">
            <button class="btn btn-ghost" onclick="paradigmApp.reset()" style="margin-bottom:20px;">Exit Test</button>
            <h2 id="test-title">Test</h2>
            <div class="card">
                <div class="macron-bar">
                    <span style="color:var(--text-muted); align-self:center; margin-right:10px;">Type:</span>
                    <div class="macron-btn" onmousedown="globalTypeChar('ā', event)">ā</div>
                    <div class="macron-btn" onmousedown="globalTypeChar('ē', event)">ē</div>
                    <div class="macron-btn" onmousedown="globalTypeChar('ī', event)">ī</div>
                    <div class="macron-btn" onmousedown="globalTypeChar('ō', event)">ō</div>
                    <div class="macron-btn" onmousedown="globalTypeChar('ū', event)">ū</div>
                </div>
                <div id="test-intro" style="margin-bottom:20px; font-size:1.5rem; text-align:center; color:#fff; font-family:var(--font-serif);"></div>
                <div id="test-content"></div>
                <div style="margin-top:30px; border-top:1px solid var(--glass-border); padding-top:20px; display:flex; justify-content:space-between; align-items:center;">
                    <div id="test-score" style="font-size:1.2rem; color:var(--primary); font-weight:bold;">Potential Score: 50 / 50</div>
                    <div>
                        <button class="btn btn-primary" onclick="paradigmApp.gradeTest()">Check Answers</button>
                        <button class="btn btn-ghost" onclick="paradigmApp.resetCurrent()">Try Again</button>
                        <button class="btn btn-ghost" onclick="paradigmApp.newTest()">New Word</button>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- READING APP -->
<div id="app-reading" class="hidden app-container">
    <aside>
        <div class="brand" onclick="router.home()"><i class="fas fa-arrow-left"></i> &nbsp;Back to Home</div>
        <nav>
            <button class="active" onclick="readingApp.nav('input')"><i class="fas fa-pen-nib"></i> Editor</button>
            <button onclick="readingApp.nav('reader')"><i class="fas fa-book-reader"></i> Reader Mode</button>
            <button onclick="readingApp.nav('lines')"><i class="fas fa-list-ul"></i> Line-by-Line</button>
            <button onclick="readingApp.nav('quiz')"><i class="fas fa-graduation-cap"></i> Translation Quiz</button>
        </nav>
    </aside>
    <main>
        <div id="view-input" class="container">
            <h2>Input Story</h2>
            <div class="card">
                <textarea id="latin-input" placeholder="Paste Latin text here..."></textarea>
                <div class="toolbar">
                    <div style="display:flex; gap:10px;">
                        <input type="file" id="file-upload" accept="image/*" style="display:none" onchange="readingApp.handleOCR(this)">
                        <button class="btn btn-ghost" onclick="document.getElementById('file-upload').click()">Scan</button>
                        <button class="btn btn-magic" onclick="readingApp.cleanAI()">AI Auto-Fix</button>
                    </div>
                    <button class="btn btn-primary" onclick="readingApp.processText()">Load Story</button>
                </div>
            </div>
        </div>
        <div id="view-reader" class="container hidden"><h2>Reader Mode</h2><div class="card"><div id="reader-content" class="latin-text"></div></div></div>
        <div id="view-lines" class="container hidden"><h2>Line-by-Line</h2><div id="lines-content" style="margin-top:20px;"></div></div>
        <div id="view-quiz" class="container hidden"><h2>Translation Quiz</h2><div id="quiz-content"></div></div>
    </main>
</div>

<div id="popover" class="popover"><div id="pop-content"></div></div>

<script>
// --- MACRON INPUT ---
function globalTypeChar(char, e) {
    e.preventDefault();
    const el = document.activeElement;
    if(el && (el.tagName==='INPUT'||el.tagName==='TEXTAREA')) {
        const s = el.selectionStart, e = el.selectionEnd, v = el.value;
        el.value = v.substring(0, s) + char + v.substring(e);
        el.selectionStart = el.selectionEnd = s + 1;
        triggerInput(el);
    }
}
document.addEventListener('input', function(e) {
    if(e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
        const el = e.target, val = el.value, c = el.selectionStart;
        const map = {'(a)':'ā','(e)':'ē','(i)':'ī','(o)':'ō','(u)':'ū'};
        if(c >= 3) {
            const key = val.substring(c-3, c);
            if(map[key]) {
                el.value = val.substring(0, c-3) + map[key] + val.substring(c);
                el.selectionStart = el.selectionEnd = c - 2;
            }
        }
    }
});
function triggerInput(el) { const event = new Event('input', { bubbles: true }); el.dispatchEvent(event); }

// --- ROUTER ---
const router = {
    open: function(n) { ['home','reading','flashcards','paradigm'].forEach(id=>document.getElementById('app-'+id).classList.add('hidden')); document.getElementById('app-'+n).classList.remove('hidden'); },
    home: function() { ['home','reading','flashcards','paradigm'].forEach(id=>document.getElementById('app-'+id).classList.add('hidden')); document.getElementById('app-home').classList.remove('hidden'); }
};

// --- OFFICIAL DICTIONARY (SUBURANI EXTRACT) ---
const SUBURANI_DICT = [
    {k:"ancilla",d:"slave-girl",t:"Noun"},{k:"cibus",d:"food",t:"Noun"},{k:"via",d:"street, way",t:"Noun"},{k:"dominus",d:"master",t:"Noun"},
    {k:"dormio",d:"sleep",t:"Verb"},{k:"intro",d:"enter",t:"Verb"},{k:"laetus",d:"happy",t:"Adj"},{k:"mercator",d:"merchant",t:"Noun"},
    {k:"quoque",d:"also",t:"Adv"},{k:"saluto",d:"greet",t:"Verb"},{k:"ad",d:"to, towards",t:"Prep"},{k:"ambulo",d:"walk",t:"Verb"},
    {k:"amicus",d:"friend",t:"Noun"},{k:"clamo",d:"shout",t:"Verb"},{k:"ecce",d:"look!",t:"Interj"},{k:"et",d:"and",t:"Conj"},
    {k:"exspecto",d:"wait for",t:"Verb"},{k:"forum",d:"forum",t:"Noun"},{k:"ianua",d:"door",t:"Noun"},{k:"iratus",d:"angry",t:"Adj"},
    {k:"leo",d:"lion",t:"Noun"},{k:"magnus",d:"big",t:"Adj"},{k:"navis",d:"ship",t:"Noun"},{k:"non",d:"not",t:"Adv"},
    {k:"porto",d:"carry",t:"Verb"},{k:"respondeo",d:"reply",t:"Verb"},{k:"rideo",d:"laugh",t:"Verb"},{k:"salve",d:"hello",t:"Interj"},
    {k:"surgo",d:"get up",t:"Verb"},{k:"taberna",d:"shop",t:"Noun"},{k:"video",d:"see",t:"Verb"},{k:"villa",d:"house",t:"Noun"},
    {k:"vinum",d:"wine",t:"Noun"},{k:"ago",d:"do, act, drive",t:"Verb"},{k:"anulus",d:"ring",t:"Noun"},{k:"coquo",d:"cook",t:"Verb"},
    {k:"cur",d:"why?",t:"Adv"},{k:"e",d:"from, out of",t:"Prep"},{k:"ego",d:"I",t:"Pronoun"},{k:"eheu",d:"oh dear!",t:"Interj"},
    {k:"habeo",d:"have",t:"Verb"},{k:"inquit",d:"says",t:"Verb"},{k:"iudex",d:"judge",t:"Noun"},{k:"mendax",d:"liar",t:"Noun"},
    {k:"pecunia",d:"money",t:"Noun"},{k:"perterritus",d:"terrified",t:"Adj"},{k:"poeta",d:"poet",t:"Noun"},{k:"quaero",d:"search for",t:"Verb"},
    {k:"quis",d:"who?",t:"Pronoun"},{k:"reddo",d:"give back",t:"Verb"},{k:"satis",d:"enough",t:"Adv"},{k:"sed",d:"but",t:"Conj"},
    {k:"signum",d:"sign, seal",t:"Noun"},{k:"tu",d:"you",t:"Pronoun"},{k:"vendo",d:"sell",t:"Verb"},{k:"voco",d:"call",t:"Verb"},
    {k:"curro",d:"run",t:"Verb"},{k:"laboro",d:"work",t:"Verb"},{k:"bibo",d:"drink",t:"Verb"},{k:"scribo",d:"write",t:"Verb"},
    {k:"peto",d:"attack, ask for, head for",t:"Verb"}
];

// --- PARADIGM DATASETS ---
const NOUNS = [ { stem: "ancill", decl: 1, word: "ancilla, -ae (f)" }, { stem: "cib", decl: 2, word: "cibus, -ī (m)" }, { stem: "mercator", decl: 3, word: "mercātor, -is (m)" }, { stem: "vill", decl: 1, word: "vīlla, -ae (f)" } ];
const VERBS = [ { stem: "port", conj: 1, word: "portō, portāre, portāvī" }, { stem: "sed", conj: 2, word: "sedeō, sedēre, sēdī" } ];
const ENDINGS = { noun1: { ns:"a", as:"am", ds:"ae", bs:"ā", np:"ae", ap:"ās", dp:"īs", bp:"īs" }, noun2: { ns:"us", as:"um", ds:"ō", bs:"ō", np:"ī", ap:"ōs", dp:"īs", bp:"īs" }, noun3: { ns:"", as:"em", ds:"ī", bs:"e", np:"ēs", ap:"ēs", dp:"ibus", bp:"ibus" }, verbPres: ["ō","ās","at","āmus","ātis","ant"], verbImp: ["ābam","ābās","ābat","ābāmus","ābātis","ābant"], verbPerf: ["āvī","āvistī","āvit","āvimus","āvistis","āvērunt"] };

// --- PARADIGM APP ---
const paradigmApp = {
    currentType: null, hintPenalty: 0,
    show: function(t) { document.getElementById('para-select').classList.add('hidden'); if(t==='nouns') document.getElementById('para-nouns').classList.remove('hidden'); if(t==='verbs') document.getElementById('para-verbs').classList.remove('hidden'); },
    reset: function() { ['para-nouns','para-verbs','para-test'].forEach(id=>document.getElementById(id).classList.add('hidden')); document.getElementById('para-select').classList.remove('hidden'); },
    startTest: function(type) { document.getElementById('para-select').classList.add('hidden'); document.getElementById('para-test').classList.remove('hidden'); this.currentType = type; this.newTest(); },
    
    newTest: function() {
        this.hintPenalty = 0; document.getElementById('test-score').innerText = "Potential Score: 50 / 50";
        const container = document.getElementById('test-content'); const intro = document.getElementById('test-intro'); container.innerHTML = "";
        
        if (this.currentType === 'noun') {
            const word = NOUNS[Math.floor(Math.random() * NOUNS.length)];
            const e = ENDINGS[`noun${word.decl}`];
            let nomS = word.decl === 3 ? word.word.split(',')[0] : word.stem + e.ns;
            document.getElementById('test-title').innerText = "Noun Test"; intro.innerHTML = `Decline: <strong>${word.word}</strong>`;
            container.innerHTML = `<div class="noun-test-grid"><div></div><div class="noun-header">Singular</div><div class="noun-header">Plural</div>${this.makeRow('Nominative', nomS, word.stem+e.np)}${this.makeRow('Dative', word.stem+e.ds, word.stem+e.dp)}${this.makeRow('Accusative', word.stem+e.as, word.stem+e.ap)}${this.makeRow('Ablative', word.stem+e.bs, word.stem+e.bp)}</div>`;
        } else {
            const word = VERBS[Math.floor(Math.random() * VERBS.length)];
            const tenses = [{id:"Pres", lbl:"Present"}, {id:"Imp", lbl:"Imperfect"}, {id:"Perf", lbl:"Perfect"}];
            const tense = tenses[Math.floor(Math.random() * tenses.length)];
            let stem = word.stem; let endings = ENDINGS[`verb${tense.id}`];
            if(tense.id === "Perf") { endings = ["ī","istī","it","imus","istis","ērunt"]; if(word.conj === 1) stem = word.stem + "āv"; }
            document.getElementById('test-title').innerText = "Verb Test"; intro.innerHTML = `Conjugate <strong>${word.word}</strong> in <span style="color:var(--primary)">${tense.lbl}</span> tense.`;
            container.innerHTML = `<div class="verb-test-container">${this.makeVerbRow('Ego (I)', stem+endings[0])}${this.makeVerbRow('Tu (You)', stem+endings[1])}${this.makeVerbRow('Is (He/She)', stem+endings[2])}${this.makeVerbRow('Nos (We)', stem+endings[3])}${this.makeVerbRow('Vos (Y\'all)', stem+endings[4])}${this.makeVerbRow('Ei (They)', stem+endings[5])}</div>`;
        }
    },
    makeRow: function(l, a1, a2) { return `<span class="noun-label">${l}</span><div class="input-group"><input class="test-input" data-ans="${a1}"><button class="btn-hint" onclick="paradigmApp.giveHint(this)"><i class="fas fa-lightbulb"></i></button></div><div class="input-group"><input class="test-input" data-ans="${a2}"><button class="btn-hint" onclick="paradigmApp.giveHint(this)"><i class="fas fa-lightbulb"></i></button></div>`; },
    makeVerbRow: function(l, a) { return `<span class="verb-person">${l}</span><div class="input-group"><input class="test-input" data-ans="${a}"><button class="btn-hint" onclick="paradigmApp.giveHint(this)"><i class="fas fa-lightbulb"></i></button></div>`; },
    giveHint: function(btn) { if(btn.classList.contains('used')) return; const input = btn.previousElementSibling; input.value = input.dataset.ans; input.classList.add('hinted-input'); btn.classList.add('used'); btn.style.opacity = "0.3"; this.hintPenalty += 4; this.updateScoreDisplay(); },
    updateScoreDisplay: function() { document.getElementById('test-score').innerText = `Potential Score: ${Math.max(0, 50 - this.hintPenalty)} / 50`; },
    gradeTest: function() { const inputs = document.querySelectorAll('.test-input'); let correctCount = 0; let totalQs = inputs.length; inputs.forEach(inp => { const correct = inp.dataset.ans; const user = inp.value.trim(); if(inp.classList.contains('hinted-input')) { correctCount++; } else if(user === correct) { inp.classList.add('correct'); inp.classList.remove('incorrect'); correctCount++; } else { inp.classList.add('incorrect'); inp.classList.remove('correct'); inp.value = `${user} ➔ ${correct}`; } }); const pointsPerQ = 50 / totalQs; let rawScore = correctCount * pointsPerQ; let finalScore = Math.max(0, Math.round(rawScore - this.hintPenalty)); document.getElementById('test-score').innerText = `Final Score: ${finalScore} / 50`; },
    resetCurrent: function() { document.querySelectorAll('.test-input').forEach(i => { if(i.value.includes('➔')) i.value = ""; i.className="test-input"; }); document.querySelectorAll('.btn-hint').forEach(b => { b.classList.remove('used'); b.style.opacity="1"; }); this.hintPenalty = 0; this.updateScoreDisplay(); }
};

// --- READING APP ---
class ReadingApp {
    constructor() { this.rawText = ""; this.sentences = []; }
    nav(view) { ['view-input', 'view-reader', 'view-lines', 'view-quiz'].forEach(id => document.getElementById(id).classList.add('hidden')); document.getElementById('view-' + view).classList.remove('hidden'); if(view==='reader') this.renderReader(); if(view==='lines') this.renderLines(); if(view==='quiz') this.genQuiz(); }
    
    cleanAI() {
        const ta = document.getElementById('latin-input');
        let text = ta.value.replace(/\d+/g,"").replace(/\|/g,"I").replace(/\s+/g," ");
        const words = text.split(" ");
        const fixed = words.map(w => {
            const clean = w.replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,"").toLowerCase();
            if(clean.length < 3) return w;
            if(this.lookup(clean)) return w; 
            let best = w; let min = 3;
            SUBURANI_DICT.forEach(entry => {
                const dist = this.levenshtein(clean, entry.k);
                if(dist < min) { min = dist; best = entry.k; }
            });
            return (min < 3 && best !== w) ? best : w;
        });
        ta.value = fixed.join(" ");
    }
    levenshtein(a,b) { if(!a||!b) return (a||b).length; const m=[]; for(let i=0;i<=b.length;i++){m[i]=[i]; if(i===0)continue; for(let j=0;j<=a.length;j++){m[0][j]=j; if(j===0)continue; m[i][j]=b.charAt(i-1)==a.charAt(j-1)?m[i-1][j-1]:Math.min(m[i-1][j-1]+1,m[i][j-1]+1,m[i-1][j]+1);}} return m[b.length][a.length]; }
    
    lookup(w) { return SUBURANI_DICT.find(e => e.k === w.toLowerCase()) || null; }

    async fetchGoogle(text, sl="la", tl="en") { 
        try{const r=await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=${sl}&tl=${tl}&dt=t&dt=bd&q=${encodeURIComponent(text)}`); return await r.json();}
        catch(e){return null;}
    }

    // --- NEW ROBUST SCANNER ---
    async handleOCR(input) {
        const file = input.files[0]; if(!file) return;
        input.value = ''; // Reset input to allow re-selection
        const ov = document.getElementById('loading-overlay'); 
        const tx = document.getElementById('loading-text'); 
        const sub = document.getElementById('loading-sub');
        const target = document.getElementById('latin-input');

        ov.classList.remove('hidden'); 
        tx.innerText = "Initializing Scanner...";
        sub.innerText = "This may take a few seconds...";

        try {
            // Use Tesseract.recognize directly (simplified one-shot)
            // Using 'eng' is safer/faster for general Latin alphabet reading than downloading the 20MB 'lat' trained data
            const ret = await Tesseract.recognize(
                file, 
                'eng', 
                { logger: m => {
                    if(m.status === 'recognizing text') {
                        tx.innerText = "Reading Text...";
                        sub.innerText = `${Math.round(m.progress * 100)}%`;
                    }
                }}
            );
            
            target.value = ret.data.text;
            
        } catch(e) {
            alert("Scanner error. Please try a clearer image.");
            console.error(e);
        } finally {
            ov.classList.add('hidden');
        }
    }

    processText(){ this.rawText=document.getElementById('latin-input').value; if(!this.rawText.trim())return; this.sentences=this.rawText.match(/[^\.!\?]+[\.!\?]+/g)||[this.rawText]; this.nav('reader'); }
    
    renderReader(){ const d=document.getElementById('reader-content'); d.innerHTML=''; this.sentences.forEach(s=>{ const sp=document.createElement('span'); s.split(/\s+/).forEach(t=>{ const w=document.createElement('span'); w.className='word'; w.innerText=t+" "; w.onclick=(e)=>{e.stopPropagation();this.showDef(t.replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,""));}; sp.appendChild(w); }); d.appendChild(sp); }); document.onclick=(e)=>{if(!e.target.classList.contains('word'))document.getElementById('popover').style.display='none';}}
    
    async showDef(w) {
        const p=document.getElementById('popover'); p.style.display='block'; 
        const local = this.lookup(w);
        if(local) { document.getElementById('pop-content').innerHTML=`<div class="pop-head">${local.k} <span style="font-size:0.8rem; color:var(--accent)">${local.t}</span></div><div style="color:var(--success)">${local.d}</div><div style="font-size:0.8rem; color:#666; margin-top:5px;">(Official)</div>`; return; }
        document.getElementById('pop-content').innerHTML='Loading Google...';
        const d=await this.fetchGoogle(w); const html=`<div class="pop-head">${w}</div><div style="color:var(--success)">${d?d[0][0][0]:'Unknown'}</div>`; document.getElementById('pop-content').innerHTML=html; 
    }
    
    async renderLines(){ 
        const d=document.getElementById('lines-content'); d.innerHTML=''; 
        for(let i=0;i<this.sentences.length;i++){ 
            const s=this.sentences[i]; 
            const c=document.createElement('div'); c.className='card line-item'; 
            
            // 1. Get Translation
            const data=await this.fetchGoogle(s); 
            let trans = data?data[0][0][0]:'Error';
            
            // 2. Context Highlight
            let glossHTML = `<div class="li-gloss">`;
            const words = s.split(/\s+/);
            words.forEach(raw => {
                const clean = raw.toLowerCase().replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,"");
                const entry = this.lookup(clean);
                if(entry) {
                    const defs = entry.d.split(',');
                    let matchedDef = defs[0];
                    let isMatch = false;
                    for(let def of defs) { if(trans.toLowerCase().includes(def.trim())) { matchedDef = def.trim(); isMatch = true; break; } }
                    const styleClass = isMatch ? 'def-match' : '';
                    glossHTML += `<div class="gloss-chip"><span class="gloss-lat">${clean}</span><span style="color:#aaa">:</span><span class="${styleClass}">${matchedDef}</span></div>`;
                }
            });
            glossHTML += `</div>`;

            c.innerHTML=`<div class="li-lat">${s}</div><div class="li-trans">${trans}</div>${glossHTML}`; 
            d.appendChild(c); 
            await new Promise(r=>setTimeout(r,100)); 
        } 
    }
    
    genQuiz(){ const d=document.getElementById('quiz-content'); d.innerHTML=''; if(this.sentences.length===0){d.innerHTML='<p>Load text first</p>'; return;} const indices = []; while(indices.length < Math.min(3, this.sentences.length)) { const r = Math.floor(Math.random()*this.sentences.length); if(indices.indexOf(r)===-1) indices.push(r); } indices.forEach((idx,i)=>{ const div=document.createElement('div'); div.className='card quiz-item'; div.innerHTML=`<div class="li-lat" id="qt-${i}">${this.sentences[idx]}</div><input id="qi-${i}" class="quiz-input" placeholder="Translate..."><div id="qf-${i}" class="qi-feedback"></div>`; d.appendChild(div); }); const b=document.createElement('button'); b.className='btn btn-primary'; b.innerText='Check All'; b.onclick=()=>this.checkAll(indices); d.appendChild(b); }
    async checkAll(indices){ for(let i=0; i<indices.length; i++){ const ans = document.getElementById(`qi-${i}`).value; const real = await this.fetchGoogle(this.sentences[indices[i]]); document.getElementById(`qf-${i}`).style.display = "block"; document.getElementById(`qf-${i}`).innerHTML = `<span style="color:#aaa">Correct:</span> <span class="qi-google">${real[0][0][0]}</span>`; await new Promise(r=>setTimeout(r,100)); } }
}
const readingApp = new ReadingApp();
</script>
</body>
</html>
